name: Benchmark Comparison

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Base reference (branch/tag/commit) to compare against'
        required: false
        default: 'main'

jobs:
  compare:
    name: Compare Performance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          path: pr

      - name: Checkout base code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha || github.event.inputs.base_ref || 'main' }}
          path: base

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run benchmarks on PR code
        run: |
          cd pr
          mkdir -p ../comparison-results
          echo "Running benchmarks on PR code..."
          go test -bench=. -benchmem -benchtime=3s -run=^$ \
            | tee ../comparison-results/pr-benchmarks.txt

      - name: Run benchmarks on base code
        run: |
          cd base
          echo "Running benchmarks on base code..."
          go test -bench=. -benchmem -benchtime=3s -run=^$ \
            | tee ../comparison-results/base-benchmarks.txt

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Compare results
        run: |
          cd comparison-results
          echo "Generating comparison report..."
          benchstat base-benchmarks.txt pr-benchmarks.txt | tee comparison.txt

      - name: Generate markdown report
        run: |
          cd comparison-results

          cat > comparison-report.md << 'EOF'
          # Performance Comparison Report

          **PR**: #${{ github.event.pull_request.number || 'N/A' }}
          **Base**: ${{ github.event.pull_request.base.sha || github.event.inputs.base_ref || 'main' }}
          **Head**: ${{ github.event.pull_request.head.sha || github.sha }}
          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---

          ## Comparison Results

          The following table shows performance differences between the base and PR:

          ```
          $(cat comparison.txt)
          ```

          ---

          ## Interpretation Guide

          - **Positive changes** indicate the PR is faster/uses less memory
          - **Negative changes** indicate the PR is slower/uses more memory
          - **~** means the difference is not statistically significant

          ### Metrics
          - **time/op**: Time per operation (lower is better)
          - **alloc/op**: Bytes allocated per operation (lower is better)
          - **allocs/op**: Number of allocations per operation (lower is better)

          ---

          ## Performance Thresholds

          ‚ö†Ô∏è **Action Required** if:
          - Any benchmark shows > 20% regression
          - Memory usage increases > 30%
          - Allocations increase > 50%

          ‚úÖ **Good to merge** if:
          - All benchmarks show improvement or < 5% regression
          - No significant memory regressions

          ---

          ## Raw Results

          ### Base Benchmarks
          See [base-benchmarks.txt](base-benchmarks.txt)

          ### PR Benchmarks
          See [pr-benchmarks.txt](pr-benchmarks.txt)

          EOF

          echo "Comparison report generated!"

      - name: Check for regressions
        id: check_regression
        run: |
          cd comparison-results

          # Simple regression check: look for significant slowdowns
          if grep -E '\+[0-9]{2,}\.[0-9]+%' comparison.txt > regressions.txt; then
            echo "has_regression=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Performance regressions detected:"
            cat regressions.txt
          else
            echo "has_regression=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No significant regressions detected"
          fi

      - name: Upload comparison results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-comparison
          path: comparison-results/
          retention-days: 30

      - name: Comment on PR (if regression detected)
        if: github.event_name == 'pull_request' && steps.check_regression.outputs.has_regression == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison-results/comparison.txt', 'utf8');
            const regressions = fs.readFileSync('comparison-results/regressions.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Performance Regression Detected

            This PR introduces performance regressions:

            \`\`\`
            ${regressions}
            \`\`\`

            <details>
            <summary>Full Comparison Report</summary>

            \`\`\`
            ${comparison}
            \`\`\`

            </details>

            Please review the benchmark results and consider optimizations before merging.

            üìä [Download full report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `
            });

      - name: Summary
        run: |
          echo "========================================="
          echo "Benchmark Comparison Complete!"
          echo "========================================="
          echo ""
          echo "Results saved to artifacts."
          echo "Check the comparison report for detailed analysis."
